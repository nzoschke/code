#!/usr/bin/env ruby

$:.unshift(
  File.expand_path(
    File.join(__FILE__, "..", "..", "lib")
  )
)

require "code/http/compiler"
require "unicorn"

app = Rack::Builder.new {
  use Rack::CommonLogger
  use Rack::ShowExceptions

  map("/") { run Code::HTTP::Compiler.new }
}

opts = {
  after_fork:       ->(s,w) { Code::HTTP::Compiler.put_server_info }, # TODO: stop if callback doesn't work?
  listeners:        "0.0.0.0:#{ENV["PORT"] || 5000}",
  timeout:          1800,
  worker_processes: 1
}

Unicorn::HttpServer.new(app, opts).start.join